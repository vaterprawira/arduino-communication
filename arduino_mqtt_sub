
import paho.mqtt.client as mqtt
import serial
import time

SERIAL_PORT = '/dev/ttyACM0' 
BAUD_RATE = 9600  
ser = None 

MQTT_BROKER = "localhost" 
MQTT_PORT = 1883
MQTT_TOPIC_SUB = "arduino/led/status"

def on_connect(client, userdata, flags, rc):
    print(f"Terhubung ke Broker dengan kode hasil: {rc}")
    client.subscribe(MQTT_TOPIC_SUB)
    print(f"Berlangganan ke topik: {MQTT_TOPIC_SUB}")

def on_message(client, userdata, msg):
    payload = msg.payload.decode() 
    topic = msg.topic
    print(f"Pesan MQTT diterima: Topik='{topic}', Pesan='{payload}'")

    if ser and ser.isOpen():
        try:
            ser.write(f"{payload}\n".encode())
            print(f"-> Mengirim '{payload}' ke Arduino via Serial.")
        except serial.SerialException as e:
            print(f"ERROR mengirim data Serial: {e}")
    else:
        print("Serial port tidak terbuka atau tidak tersedia.")

def main():
    global ser
    
    try:
        ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=1)
        time.sleep(2) 
        print(f"Serial port {SERIAL_PORT} terbuka.")
    except serial.SerialException as e:
        print(f"ERROR: Gagal membuka serial port {SERIAL_PORT}. Cek kabel dan izin port.")
        print(e)
        return

    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message

    try:
        client.connect(MQTT_BROKER, MQTT_PORT, 60)
    except Exception as e:
        print(f"ERROR: Gagal terhubung ke MQTT Broker. Cek Mosquitto service.")
        print(e)
        return

    client.loop_forever()

if __name__ == '__main__':
    main()
